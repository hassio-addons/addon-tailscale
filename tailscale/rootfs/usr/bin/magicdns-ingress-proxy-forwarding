#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Setup DNAT for incoming MagicDNS queries toward ingress dnsmasq proxy
# ==============================================================================

readonly MAGIC_DNS_IPV4="100.100.100.100"
readonly MAGIC_DNS_IPV6="fd7a:115c:a1e0::53"

readonly DNSMASQ_INGRESS_PORT=53

declare hassio_dns_ipv4
declare hassio_dns_ipv6

declare tailscale_address_ipv4
declare tailscale_address_ipv6

function setup_forwarding() {
  local cmd="$1"
  local sub_cmd="$2"
  local proto="$3"
  local ip_version="$4"
  local address_bits="$5"
  local source_address="$6"
  local from_address="$7"
  local to_address="$8"
  local to_port="$9"

  bashio::log.info "Setting up forwarding for MagicDNS ingress proxy (${proto}, ${ip_version})"
  if ${cmd} -t nat -S PREROUTING \
    | grep -Eq "^-A PREROUTING -s ${source_address//[\[\]]/}/${address_bits} -d ${from_address//[\[\]]/}/${address_bits} -i hassio -p ${proto} -m ${proto} --dport 53 -j DNAT --to-destination $(sed -r 's/(\[|\])/\\\1/g' <<< "${to_address}"):${to_port}$"
  then
    bashio::log.notice "Forwarding is already set for MagicDNS ingress proxy (${proto}, ${ip_version})"
  else
    if ! ${cmd} -t nat -${sub_cmd} PREROUTING -s ${source_address//[\[\]]/} -d ${from_address//[\[\]]/} -i hassio -p ${proto} --dport 53 -j DNAT --to-destination ${to_address}:${to_port}; then
      bashio::log.warning "Setting up forwarding for MagicDNS ingress proxy is unsuccessful (${proto}, ${ip_version})"
    fi
  fi
}

function remove_forwarding() {
  local cmd="$1"
  local ip_version="$2"
  local address_bits="$3"
  local source_address="$4"
  local from_address="$5"
  local to_address="$6"
  local to_port="$7"

  local proto

  for proto in $( \
    ${cmd} -t nat -S PREROUTING \
    | { grep -E "^-A PREROUTING -s ${source_address//[\[\]]/}/${address_bits} -d ${from_address//[\[\]]/}/${address_bits} -i hassio -p \S+ -m \S+ --dport 53 -j DNAT --to-destination $(sed -r 's/(\[|\])/\\\1/g' <<< "${to_address}"):${to_port}$" || true ;} \
    | sed -nr 's/^.*?-p\s(\S+).*$/\1/p')
  do
    bashio::log.info "Removing forwarding for MagicDNS ingress proxy (${proto}, ${ip_version})"
    if ! ${cmd} -t nat -D OUTPUT -s ${source_address//[\[\]]/} -d ${from_address//[\[\]]/} -i hassio -p ${proto} --dport 53 -j DNAT --to-destination ${to_address}:${to_port}; then
      bashio::log.warning "Removing forwarding for MagicDNS ingress proxy is unsuccessful (${proto}, ${ip_version})"
    fi
  done
}

function dig_hassio_dns() {
  local type="$1"
  dig dns.local.hass.io "${type}" +short | { grep -Ev '^;|\.$|^$' || true ;}
}

# Hassio DNS's IP addresses
if ! hassio_dns_ipv4=$(dig_hassio_dns A) || \
  ! hassio_dns_ipv6 = $(dig_hassio_dns AAAA) || \ # for the status of IPv6 support see https://github.com/home-assistant/supervisor/issues/2133
  bashio::var.is_empty "${hassio_dns_ipv4}" && bashio::var.is_empty "${hassio_dns_ipv6}"
then
  bashio::log.error "Failed to resolve Home Assistant's DNS address"
  bashio::exit.nok
fi
# Tailscale's local IP addresses
if bashio::var.equals "${2-}" "forwarding"; then
  if ! tailscale_address_ipv4=$(/opt/tailscale ip -4) || \
    ! tailscale_address_ipv6=$(/opt/tailscale ip -6) || \
    bashio::var.is_empty "${tailscale_address_ipv4}" && bashio::var.is_empty "${tailscale_address_ipv6}"
  then
    bashio::log.error "Failed to retrieve Tailscale's local address"
    bashio::exit.nok
  fi
  if bashio::var.has_value "${hassio_dns_ipv4}" && bashio::var.is_empty "${tailscale_address_ipv4}" || \
    bashio::var.has_value "${hassio_dns_ipv6}" && bashio::var.is_empty "${tailscale_address_ipv6}"
  then
    bashio::log.error "Failed to retrieve Tailscale's local address with matching IP version (v4 or v6) to Home Assistant's DNS address"
    bashio::exit.nok
  fi
fi

case "${1-}-${2-}" in
  setup-drop)
    # Due to forwarding to localhost is not enabled in HA OS, this is de facto a DROP (see martian packets).
    # This temporary trick is needed, because when TS starts, it adds a general ACCEPT FORWARD line in front of existing settings,
    # so we have to drop it during PREROUTING.
    if bashio::var.has_value "${hassio_dns_ipv4}"; then
      setup_forwarding "iptables" "I" "udp" "IPv4" "32" "${hassio_dns_ipv4}" "${MAGIC_DNS_IPV4}" "127.0.0.1" "0"
      setup_forwarding "iptables" "I" "tcp" "IPv4" "32" "${hassio_dns_ipv4}" "${MAGIC_DNS_IPV4}" "127.0.0.1" "0"
    fi
    if bashio::var.has_value "${hassio_dns_ipv6}"; then
      setup_forwarding "ip6tables" "I" "udp" "IPv6" "128" "${hassio_dns_ipv6}" "${MAGIC_DNS_IPV6}" "[::1]" "0"
      setup_forwarding "ip6tables" "I" "tcp" "IPv6" "128" "${hassio_dns_ipv6}" "${MAGIC_DNS_IPV6}" "[::1]" "0"
    fi
    ;;
  setup-forwarding)
    if bashio::var.has_value "${hassio_dns_ipv4}"; then
      setup_forwarding "iptables" "A" "udp" "IPv4" "32" "${hassio_dns_ipv4}" "${MAGIC_DNS_IPV4}" "${tailscale_address_ipv4}" "${DNSMASQ_INGRESS_PORT}"
      setup_forwarding "iptables" "A" "tcp" "IPv4" "32" "${hassio_dns_ipv4}" "${MAGIC_DNS_IPV4}" "${tailscale_address_ipv4}" "${DNSMASQ_INGRESS_PORT}"
    fi
    if bashio::var.has_value "${hassio_dns_ipv6}"; then
      setup_forwarding "ip6tables" "A" "udp" "IPv6" "128" "${hassio_dns_ipv6}" "${MAGIC_DNS_IPV6}" "[${tailscale_address_ipv6}]" "${DNSMASQ_INGRESS_PORT}"
      setup_forwarding "ip6tables" "A" "tcp" "IPv6" "128" "${hassio_dns_ipv6}" "${MAGIC_DNS_IPV6}" "[${tailscale_address_ipv6}]" "${DNSMASQ_INGRESS_PORT}"
    fi
    ;;
  remove-drop)
    if bashio::var.has_value "${hassio_dns_ipv4}"; then
      remove_forwarding "iptables" "IPv4" "32" "${hassio_dns_ipv4}" "${MAGIC_DNS_IPV4}" "127.0.0.1" "0"
    fi
    if bashio::var.has_value "${hassio_dns_ipv6}"; then
      remove_forwarding "ip6tables" "IPv6" "128" "${hassio_dns_ipv6}" "${MAGIC_DNS_IPV6}" "[::1]" "0"
    fi
    ;;
  remove-forwarding)
    if bashio::var.has_value "${hassio_dns_ipv4}"; then
      remove_forwarding "iptables" "IPv4" "32" "${hassio_dns_ipv4}" "${MAGIC_DNS_IPV4}" "${tailscale_address_ipv4}" "${DNSMASQ_INGRESS_PORT}"
    fi
    if bashio::var.has_value "${hassio_dns_ipv6}"; then
      remove_forwarding "ip6tables" "IPv6" "128" "${hassio_dns_ipv6}" "${MAGIC_DNS_IPV6}" "[${tailscale_address_ipv6}]" "${DNSMASQ_INGRESS_PORT}"
    fi
    ;;
  *)
    echo "Usage: $(basename "$0") setup|remove drop|forwarding" 1>&2
    exit 1
    ;;
esac
