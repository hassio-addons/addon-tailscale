#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Community Add-on: Tailscale
# Runs the dnsmasq daemon
# ==============================================================================

readonly DNSMASQ_ADDRESS=127.52.52.52
readonly DEFAULT_HOSTNAME="controlplane.tailscale.com"

declare hostname="${DEFAULT_HOSTNAME}"
declare -a addresses=()
declare host_record=

bashio::log.info "Starting dnsmasq..."

# Get hostname if configured
if bashio::config.has_value "login_server"; then
  # We have to be able to resolve this address
  if ! hostname=$(awk -F[/:] '{print $4}' <<<$(bashio::config "login_server")) || \
    ! bashio::var.has_value "${hostname}"
  then
    bashio::log.error "Determining host name from '$(bashio::config "login_server")' has failed"
    bashio::exit.nok
  fi
fi

# Resolve hostname
if [[ "${hostname}" != "${DEFAULT_HOSTNAME}" ]]; then
  # If non-TS controlplane is used, we must be able to resolve it before TS starts up, there is built-in fallback mechanism in TS only for it's own controlplane
  if ! readarray -t addresses < <(dig ${hostname} A ${hostname} AAAA +short) || \
    (( 0 == ${#addresses[@]} ))
  then
    bashio::log.error "Resolving '${hostname}' has failed"
    bashio::exit.nok
  fi
else
  # This is a best effort, if we fail, let TS use it's DERP servers as fallback bootstrap DNS servers
  readarray -t addresses < <(dig ${hostname} A ${hostname} AAAA +short) || true
  if (( 0 == ${#addresses[@]} )); then
    bashio::log.warning "Resolving '${hostname}' has failed, Tailscale will start up slower, using it's DERP servers as fallback bootstrap DNS servers."
  fi
fi
if (( 0 < ${#addresses[@]} )); then
  host_record="--host-record=${hostname}$(printf ",%s" "${addresses[@]}"),0"
fi

# We need to delay the starting of the dependent services until the conf file is written
echo "nameserver ${DNSMASQ_ADDRESS}" > /etc/resolv.dnsmasq.conf
echo "" >&3

# This is a dummy DNS to provide bootstrap DNS resolution for the login_server option, otherwise answers REFUSED for everything
# It is also required to suppress tailscaled warnings about not configured upstream on each DNS query
# It must run on port 53 to be able to specify it in a resolv.conf
exec dnsmasq --no-hosts --no-resolv --keep-in-foreground --log-facility='-' --listen-address=${DNSMASQ_ADDRESS} --port=53 --bind-interfaces ${host_record}
